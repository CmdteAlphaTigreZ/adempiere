DROP VIEW IF EXISTS RV_OrderInvoiceDetail;
CREATE OR REPLACE VIEW RV_OrderInvoiceDetail AS
SELECT 
 o.PriorityRule, 
 o.IsCreditApproved, 
 o.IsDelivered, 
 o.PaymentRule, 
 o.InvoiceRule, 
 o.IsDiscountPrinted, 
 o.DeliveryViaRule, 
 o.POReference, 
 o.FreightCostRule, 
 o.DeliveryRule, 
 o.Created, 
 o.DocumentNo, 
 o.CopyFrom, 
 o.IsTaxIncluded, 
 o.DocAction, 
 o.Processing, 
 o.IsSelfService, 
 o.OrderType, 
 o.C_POS_ID, 
 o.IsInvoiced, 
 o.IsSOTrx, 
 o.Weight, 
 o.PromotionCode, 
 o.IsSelected, 
 o.C_Opportunity_ID, 
 o.User3_ID, 
 o.User4_ID, 
 o.IsPrinted, 
 o.DateOrdered, 
 o.ChargeAmt, 
 o.IsTransferred, 
 o.SendEMail, 
 o.DatePrinted, 
 o.UUID, 
 o.C_Currency_ID, 
 o.C_RfQ_ID, 
 o.DocStatus, 
 o.Description, 
 o.C_BPartner_ID, 
 o.DatePromised, 
 o.C_DocTypeTarget_ID, 
 o.Volume, 
 o.CreatedBy, 
 o.DateAcct, 
 o.C_OrderSource_ID, 
 o.ProcessedOn, 
 o.Pay_BPartner_ID, 
 o.AmountRefunded, 
 o.FreightAmt, 
 o.AD_Org_ID, 
 o.Pay_Location_ID, 
 o.C_Payment_ID, 
 o.UY_OrderStatus_ID, 
 o.SalesRep_ID, 
 o.C_Campaign_ID, 
 o.C_BPartner_Location_ID, 
 o.Ref_Order_ID, 
 o.C_ConversionType_ID, 
 o.DropShip_User_ID, 
 o.DropShip_Location_ID, 
 o.DropShip_BPartner_ID, 
 o.M_FreightCategory_ID, 
 o.UY_ViaLoan_ID, 
 o.C_Order_ID, 
 o.C_DocType_ID, 
 o.M_Shipper_ID, 
 o.AD_Client_ID, 
 o.S_Contract_ID, 
 o.IsCustomerApproved, 
 o.C_Project_ID, 
 o.IsApproved, 
 o.IsActive, 
 o.TotalLines, 
 o.GrandTotal, 
 o.Updated, 
 o.Posted, 
 o.Processed, 
 o.IsDirectInvoice, 
 o.AmountTendered, 
 o.IsDropShip, 
 o.C_CashLine_ID, 
 o.AD_User_ID, 
 o.M_Warehouse_ID, 
 o.C_PaymentTerm_ID, 
 o.UpdatedBy, 
 o.M_PriceList_ID, 
 o.Bill_BPartner_ID, 
 o.C_Activity_ID, 
 o.User1_ID, 
 o.Bill_User_ID, 
 o.Bill_Location_ID, 
 o.AD_OrgTrx_ID, 
 o.User2_ID, 
 o.Link_Order_ID, 
 o.IsAllowToInvoice,  
 ol.QtyOrdered, 
 ol.LineNetAmt, 
 ol.M_Product_ID,
 ol.C_Charge_ID,
 0 C_Invoice_ID,
 0 AS RV_OrderInvoiceDetail_ID
FROM C_Order o
INNER JOIN C_OrderLine ol ON(ol.C_Order_ID = o.C_Order_ID)
WHERE COALESCE(ol.QtyInvoiced, 0) = 0
UNION ALL
SELECT 
 o.PriorityRule, 
 o.IsCreditApproved, 
 o.IsDelivered, 
 i.PaymentRule, 
 o.InvoiceRule, 
 i.IsDiscountPrinted, 
 o.DeliveryViaRule, 
 o.POReference, 
 o.FreightCostRule, 
 o.DeliveryRule, 
 o.Created, 
 i.DocumentNo, 
 o.CopyFrom, 
 i.IsTaxIncluded, 
 i.DocAction, 
 i.Processing, 
 o.IsSelfService, 
 o.OrderType, 
 o.C_POS_ID, 
 o.IsInvoiced, 
 i.IsSOTrx, 
 o.Weight, 
 o.PromotionCode, 
 o.IsSelected, 
 o.C_Opportunity_ID, 
 i.User3_ID, 
 i.User4_ID, 
 o.IsPrinted, 
 i.DateInvoiced AS DateOrdered, 
 o.ChargeAmt, 
 o.IsTransferred, 
 o.SendEMail, 
 o.DatePrinted, 
 i.UUID, 
 i.C_Currency_ID, 
 o.C_RfQ_ID, 
 i.DocStatus, 
 i.Description, 
 i.C_BPartner_ID, 
 o.DatePromised, 
 i.C_DocTypeTarget_ID, 
 o.Volume, 
 i.CreatedBy, 
 i.DateAcct, 
 o.C_OrderSource_ID, 
 i.ProcessedOn, 
 o.Pay_BPartner_ID, 
 o.AmountRefunded, 
 o.FreightAmt, 
 i.AD_Org_ID, 
 o.Pay_Location_ID, 
 i.C_Payment_ID, 
 o.UY_OrderStatus_ID, 
 i.SalesRep_ID, 
 i.C_Campaign_ID, 
 i.C_BPartner_Location_ID, 
 o.Ref_Order_ID, 
 o.C_ConversionType_ID, 
 o.DropShip_User_ID, 
 o.DropShip_Location_ID, 
 o.DropShip_BPartner_ID, 
 o.M_FreightCategory_ID, 
 o.UY_ViaLoan_ID, 
 i.C_Order_ID, 
 i.C_DocType_ID, 
 o.M_Shipper_ID, 
 i.AD_Client_ID, 
 i.S_Contract_ID, 
 o.IsCustomerApproved, 
 i.C_Project_ID, 
 i.IsApproved, 
 i.IsActive, 
 i.TotalLines, 
 i.GrandTotal, 
 i.Updated, 
 i.Posted, 
 i.Processed, 
 o.IsDirectInvoice, 
 o.AmountTendered, 
 o.IsDropShip, 
 o.C_CashLine_ID, 
 i.AD_User_ID, 
 o.M_Warehouse_ID, 
 i.C_PaymentTerm_ID, 
 i.UpdatedBy, 
 i.M_PriceList_ID, 
 o.Bill_BPartner_ID, 
 i.C_Activity_ID, 
 i.User1_ID, 
 o.Bill_User_ID, 
 o.Bill_Location_ID, 
 i.AD_OrgTrx_ID, 
 i.User2_ID, 
 o.Link_Order_ID, 
 o.IsAllowToInvoice,  
 ol.QtyOrdered, 
 il.LineNetAmt AS LineNetAmt, 
 il.M_Product_ID,
 il.C_Charge_ID,
 i.C_Invoice_ID,
 0 AS RV_OrderInvoiceDetail_ID
FROM C_Invoice i 
INNER JOIN C_InvoiceLine il ON(il.C_Invoice_ID = i.C_Invoice_ID)
LEFT JOIN C_OrderLine ol ON(ol.C_OrderLine_ID = il.C_OrderLine_ID)
LEFT JOIN C_Order o ON(o.C_Order_ID = i.C_Order_ID)
WHERE COALESCE(ol.QtyInvoiced, 1) > 0
